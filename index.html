<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Medicine Dispenser | Dashboard</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --primary-light: #eef2ff;
            --secondary: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --dark: #1a1a2e;
            --dark-light: #2d3047;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #adb5bd;
            --card-bg: #ffffff;
            --border-radius: 16px;
            --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo-icon i {
            font-size: 2rem;
            color: white;
        }

        .logo-text h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .logo-text p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--secondary);
            box-shadow: 0 0 20px var(--secondary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Main Layout */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-light);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-title i {
            color: var(--primary);
            font-size: 1.8rem;
        }

        /* Input Form */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            color: var(--dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        .form-control::placeholder {
            color: var(--gray-light);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.25);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #05c592 100%);
        }

        .btn-success:hover {
            box-shadow: 0 10px 25px rgba(6, 214, 160, 0.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #e83e8c 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 10px 25px rgba(239, 71, 111, 0.25);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Medicine Schedule */
        .schedule-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .schedule-list::-webkit-scrollbar {
            width: 6px;
        }

        .schedule-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .schedule-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .schedule-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .schedule-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .schedule-item.due-now {
            border-left-color: var(--warning);
            background: linear-gradient(135deg, #fff9db 0%, #fff3bf 100%);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 209, 102, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 209, 102, 0); }
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .medicine-name {
            font-weight: 700;
            color: var(--dark);
            font-size: 1.2rem;
        }

        .medicine-time {
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: 'SF Mono', 'Roboto Mono', monospace;
        }

        .medicine-details {
            color: var(--gray);
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(6, 214, 160, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(6, 214, 160, 0.2);
        }

        .badge-warning {
            background: rgba(255, 209, 102, 0.1);
            color: #e6a700;
            border: 1px solid rgba(255, 209, 102, 0.2);
        }

        .badge-danger {
            background: rgba(239, 71, 111, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 71, 111, 0.2);
        }

        /* Time Sync Status */
        .sync-status {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 25px;
            border: 1px solid #e2e8f0;
        }

        .sync-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--secondary);
        }

        .sync-dot.syncing {
            background-color: var(--warning);
            animation: pulse 1s infinite;
        }

        .sync-dot.error {
            background-color: var(--danger);
        }

        .time-display-container {
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            margin-top: 15px;
        }

        .time-display {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: 1px;
            margin: 10px 0;
            color: white;
        }

        .time-label {
            font-size: 0.9rem;
            text-align: center;
            opacity: 0.9;
            margin-top: 5px;
            color: #cbd5e1;
        }

        /* Logs */
        .log-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .log-list::-webkit-scrollbar {
            width: 6px;
        }

        .log-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .log-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .log-item {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: background-color 0.3s;
        }

        .log-item:hover {
            background: #f8fafc;
            border-radius: 8px;
        }

        .log-time {
            font-family: 'SF Mono', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            color: var(--gray);
            min-width: 80px;
        }

        .log-message {
            color: var(--dark);
            flex: 1;
        }

        .log-type {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
        }

        .log-success .log-type { background: var(--secondary); }
        .log-error .log-type { background: var(--danger); }
        .log-warning .log-type { background: var(--warning); }
        .log-info .log-type { background: var(--primary); }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 20px;
        }

        .footer-section h4 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Day Selection */
        .days-selection {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .day-checkbox {
            display: none;
        }

        .day-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            color: var(--gray);
        }

        .day-checkbox:checked + .day-label {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .day-label:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .days-selection {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .card {
                padding: 20px;
            }

            .days-selection {
                grid-template-columns: repeat(3, 1fr);
            }

            .medicine-details {
                flex-direction: column;
                gap: 10px;
            }

            .time-display {
                font-size: 1.5rem;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 20px;
            background: white;
            color: var(--dark);
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success { border-left-color: var(--secondary); }
        .toast-error { border-left-color: var(--danger); }
        .toast-warning { border-left-color: var(--warning); }

        .toast-icon {
            font-size: 1.5rem;
            margin-top: 2px;
        }

        .toast-success .toast-icon { color: var(--secondary); }
        .toast-error .toast-icon { color: var(--danger); }
        .toast-warning .toast-icon { color: var(--warning); }

        /* Loading Animation */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 20px;
            background: #f1f5f9;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Smart Medicine Dispenser</h1>
                        <p>Automated Medication Management System</p>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="connection-status">Initializing System...</span>
                </div>
            </div>
        </header>

        <main>
            <div class="dashboard">
                <!-- Schedule Medicine Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-calendar-plus"></i>
                            Schedule Medicine
                        </h2>
                        <span class="badge badge-success" id="active-count">0 Active</span>
                    </div>
                    <form id="medicine-form">
                        <div class="form-group">
                            <label class="form-label" for="medicine-name">
                                <i class="fas fa-capsules"></i> Medicine Name
                            </label>
                            <input type="text" id="medicine-name" class="form-control" placeholder="e.g., Amoxicillin 500mg" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="dosage">
                                <i class="fas fa-prescription-bottle"></i> Dosage
                            </label>
                            <input type="text" id="dosage" class="form-control" placeholder="e.g., 1 tablet, 5ml" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="schedule-time">
                                <i class="fas fa-clock"></i> Schedule Time (24-hour)
                            </label>
                            <input type="time" id="schedule-time" class="form-control" step="60" required>
                            <div style="font-size: 0.85rem; color: var(--gray); margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> Format: HH:MM (24-hour clock)
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-calendar-week"></i> Repeat Days
                            </label>
                            <div class="days-selection">
                                <input type="checkbox" id="day-sun" class="day-checkbox" name="days" value="0">
                                <label for="day-sun" class="day-label">Sun</label>
                                
                                <input type="checkbox" id="day-mon" class="day-checkbox" name="days" value="1" checked>
                                <label for="day-mon" class="day-label">Mon</label>
                                
                                <input type="checkbox" id="day-tue" class="day-checkbox" name="days" value="2" checked>
                                <label for="day-tue" class="day-label">Tue</label>
                                
                                <input type="checkbox" id="day-wed" class="day-checkbox" name="days" value="3" checked>
                                <label for="day-wed" class="day-label">Wed</label>
                                
                                <input type="checkbox" id="day-thu" class="day-checkbox" name="days" value="4" checked>
                                <label for="day-thu" class="day-label">Thu</label>
                                
                                <input type="checkbox" id="day-fri" class="day-checkbox" name="days" value="5" checked>
                                <label for="day-fri" class="day-label">Fri</label>
                                
                                <input type="checkbox" id="day-sat" class="day-checkbox" name="days" value="6">
                                <label for="day-sat" class="day-label">Sat</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" id="add-schedule-btn">
                            <i class="fas fa-plus-circle"></i> Add to Schedule
                        </button>
                    </form>
                    
                    <div class="sync-status">
                        <div class="sync-header">
                            <div class="sync-indicator">
                                <div class="sync-dot" id="sync-dot"></div>
                                <span id="sync-status-text">Time Synchronization</span>
                            </div>
                            <button class="btn btn-outline" id="force-sync-btn" style="width: auto; padding: 8px 16px;">
                                <i class="fas fa-sync-alt"></i> Sync Now
                            </button>
                        </div>
                        <div class="time-display-container">
                            <div class="time-label">DS3231 RTC Time</div>
                            <div class="time-display" id="rtc-time-display">--:--:--</div>
                            <div class="time-label">Real-time Synchronized</div>
                        </div>
                    </div>
                </div>

                <!-- Today's Schedule Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-calendar-day"></i>
                            Today's Schedule
                        </h2>
                        <div class="time-display" id="current-time-display" style="font-size: 1.2rem; color: var(--primary); font-weight: 600;">
                            --:--:--
                        </div>
                    </div>
                    <div class="schedule-list" id="schedule-list">
                        <div class="schedule-item empty-schedule" style="text-align: center; padding: 40px 20px; border-left: 4px solid var(--gray-light);">
                            <i class="fas fa-calendar-alt" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 15px;"></i>
                            <h3 style="color: var(--gray); margin-bottom: 10px; font-weight: 500;">No Schedule for Today</h3>
                            <p style="color: var(--gray-light);">Add medicines using the schedule form</p>
                        </div>
                    </div>
                    <div style="margin-top: 25px;">
                        <div class="progress-container">
                            <div class="progress-bar" id="schedule-progress" style="width: 0%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 12px; color: var(--gray); font-size: 0.9rem;">
                            <span>
                                <i class="fas fa-history"></i>
                                Next check: <span id="next-check-timer">60</span>s
                            </span>
                            <span>
                                <span id="dispensed-count">0</span> dispensed • <span id="pending-count">0</span> pending
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Activity Log Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-history"></i>
                            System Activity Log
                        </h2>
                        <div>
                            <button class="btn btn-outline" id="pause-logs-btn" style="width: auto; padding: 8px 16px; margin-right: 10px;">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button class="btn btn-danger" id="clear-logs-btn" style="width: auto; padding: 8px 16px;">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="log-list" id="log-list">
                        <div class="log-item log-info">
                            <div class="log-type"></div>
                            <div class="log-time">[System]</div>
                            <div class="log-message">Initializing medication dispenser system...</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; color: var(--gray); font-size: 0.9rem;">
                        <span>
                            <i class="fas fa-database"></i>
                            Log entries: <span id="log-count">1</span>
                        </span>
                        <span>
                            <i class="fas fa-wifi"></i>
                            <span id="firebase-status">Connecting...</span>
                        </span>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <div class="footer-grid">
                <div class="footer-section">
                    <h4><i class="fas fa-microchip"></i> Hardware</h4>
                    <p>ESP32 Microcontroller</p>
                    <p>DS3231 RTC Module</p>
                    <p>2x Servo Motors</p>
                    <p>Buzzer & LED System</p>
                </div>
                <div class="footer-section">
                    <h4><i class="fas fa-sync-alt"></i> Synchronization</h4>
                    <p>Real-time RTC Updates</p>
                    <p>Automatic Time Sync</p>
                    <p>Firebase Cloud Backend</p>
                    <p>24-hour Format</p>
                </div>
                <div class="footer-section">
                    <h4><i class="fas fa-shield-alt"></i> System</h4>
                    <p id="system-uptime">Uptime: --</p>
                    <p id="last-dispense-display">Last Dispense: --:--</p>
                    <p id="total-schedules">Total Schedules: 0</p>
                    <p id="auto-sync-status">Auto Sync: Enabled</p>
                </div>
            </div>
            <p style="margin-top: 25px; opacity: 0.8;">Smart Medicine Dispenser v2.0 | Professional Medication Management System</p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="toast-content">
            <strong id="toast-title">Notification</strong>
            <div id="toast-message">Message content</div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBXMrhRaJuvZydIbzp3aYebhu4gYOopxtQ",
            authDomain: "medication-system-d0d0f.firebaseapp.com",
            databaseURL: "https://medication-system-d0d0f-default-rtdb.firebaseio.com",
            projectId: "medication-system-d0d0f",
            storageBucket: "medication-system-d0d0f.firebasestorage.app",
            messagingSenderId: "222165407764",
            appId: "1:222165407764:web:0878f5ab12122f24f7ef01"
        };

        // Global variables
        let db = null;
        let scheduleRef, commandsRef, statusRef, logsRef, rtcRef, autoDispenseRef;
        let connectionStatusElement, firebaseStatusElement;
        let scheduleCheckerInterval;
        let lastScheduleCheck = 0;
        let lastRTCTime = null;
        let logPaused = false;
        let systemStartTime = Date.now();
        const CHECK_INTERVAL = 60000; // Check every 60 seconds

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM elements
            connectionStatusElement = document.getElementById('connection-status');
            firebaseStatusElement = document.getElementById('firebase-status');
            
            // Initialize the rest
            initializeEventListeners();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            setInterval(updateUptime, 1000);
            
            // Initialize Firebase after DOM is ready
            initializeFirebase();
        });

        function initializeFirebase() {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                // Initialize Firebase references
                scheduleRef = db.ref('medicine_schedule');
                commandsRef = db.ref('commands');
                statusRef = db.ref('status');
                logsRef = db.ref('logs');
                rtcRef = db.ref('rtc_time');
                autoDispenseRef = db.ref('auto_dispense');
                
                updateConnectionStatus('Connected to Firebase', 'success');
                updateFirebaseStatus('Connected ✓');
                updateSyncStatus('Synced with Firebase', 'success');
                
                // Setup Firebase listeners
                setupFirebaseListeners();
                
                // Start schedule checking
                startScheduleChecking();
                
                // Start auto sync every 1 second
                setInterval(() => {
                    forceTimeSync();
                }, 1000);
                
                addLog('Firebase connection established successfully', 'success');
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateConnectionStatus('Firebase Connection Failed', 'error');
                updateFirebaseStatus('Connection Failed ✗');
                updateSyncStatus('Firebase connection failed', 'error');
                addLog('Firebase connection failed: ' + error.message, 'error');
                initializeDemoData();
            }
        }

        function initializeEventListeners() {
            // Form submission
            document.getElementById('medicine-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addMedicineSchedule();
            });

            // Force sync button
            document.getElementById('force-sync-btn').addEventListener('click', function() {
                forceTimeSync();
            });

            // Pause logs button
            document.getElementById('pause-logs-btn').addEventListener('click', function() {
                logPaused = !logPaused;
                const btn = document.getElementById('pause-logs-btn');
                const icon = btn.querySelector('i');
                if (logPaused) {
                    btn.innerHTML = '<i class="fas fa-play"></i> Resume';
                    btn.classList.remove('btn-outline');
                    btn.classList.add('btn-success');
                    addLog('Log updates paused', 'warning');
                } else {
                    btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline');
                    addLog('Log updates resumed', 'success');
                }
            });

            // Clear logs button
            document.getElementById('clear-logs-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all logs?')) {
                    clearLogs();
                }
            });
        }

        function setupFirebaseListeners() {
            if (!db) return;
            
            // Listen for schedule updates
            scheduleRef.on('value', (snapshot) => {
                const schedules = snapshot.val();
                updateScheduleList(schedules);
                updateScheduleCounters(schedules);
            });

            // Listen for RTC time updates
            rtcRef.on('value', (snapshot) => {
                const rtcTime = snapshot.val();
                if (rtcTime) {
                    updateRTCTimeDisplay(rtcTime);
                    lastRTCTime = rtcTime;
                    checkScheduleAgainstTime(rtcTime);
                }
            });

            // Listen for auto-dispense events
            autoDispenseRef.on('value', (snapshot) => {
                const autoDispense = snapshot.val();
                if (autoDispense && autoDispense.triggered) {
                    addLog(`Auto-dispense: ${autoDispense.medicineName} at ${autoDispense.time}`, 'success');
                    showToast('Auto Dispense', `${autoDispense.medicineName} dispensed at ${autoDispense.time}`, 'success');
                    
                    // Reset the trigger after 2 seconds
                    setTimeout(() => {
                        autoDispenseRef.update({ triggered: false });
                    }, 2000);
                }
            });

            // Listen for logs
            logsRef.limitToLast(20).on('value', (snapshot) => {
                if (!logPaused) {
                    const logs = snapshot.val();
                    if (logs) {
                        updateLogDisplay(logs);
                    }
                }
            });

            // Listen for status updates
            statusRef.on('value', (snapshot) => {
                const status = snapshot.val();
                if (status) {
                    if (status.last_dispense) {
                        document.getElementById('last-dispense-display').textContent = 
                            `Last Dispense: ${status.last_dispense}`;
                    }
                    if (status.system_status) {
                        updateConnectionStatus(status.system_status, 'success');
                    }
                }
            });
        }

        function addMedicineSchedule() {
            const medicineName = document.getElementById('medicine-name').value.trim();
            const dosage = document.getElementById('dosage').value.trim();
            const scheduleTime = document.getElementById('schedule-time').value;
            
            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('.day-checkbox:checked').forEach(checkbox => {
                selectedDays.push(parseInt(checkbox.value));
            });
            
            if (!medicineName || !dosage || !scheduleTime || selectedDays.length === 0) {
                showToast('Validation Error', 'Please fill all fields and select at least one day', 'error');
                return;
            }

            // Validate time format
            const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (!timeRegex.test(scheduleTime)) {
                showToast('Invalid Time', 'Please use HH:MM format (24-hour)', 'error');
                return;
            }

            const medicineId = Date.now().toString();
            const scheduleData = {
                id: medicineId,
                name: medicineName,
                dosage: dosage,
                time: scheduleTime, // HH:MM format
                days: selectedDays,
                timestamp: new Date().toISOString(),
                dispensed: false,
                lastDispensed: null,
                active: true,
                createdAt: Date.now()
            };

            if (db && scheduleRef) {
                scheduleRef.child(medicineId).set(scheduleData)
                    .then(() => {
                        showToast('Schedule Added', `${medicineName} scheduled for ${scheduleTime}`, 'success');
                        addLog(`Scheduled: ${medicineName} at ${scheduleTime}`, 'success');
                        document.getElementById('medicine-form').reset();
                    })
                    .catch((error) => {
                        showToast('Error', 'Failed to add schedule: ' + error.message, 'error');
                        addLog('Failed to add schedule: ' + error.message, 'error');
                    });
            } else {
                // Demo mode
                addLog(`Scheduled: ${medicineName} at ${scheduleTime} (Demo)`, 'success');
                showToast('Demo Mode', 'Schedule added (Demo Mode)', 'warning');
                document.getElementById('medicine-form').reset();
            }
        }

        function updateScheduleList(schedules) {
            const scheduleListElement = document.getElementById('schedule-list');
            
            if (!schedules || Object.keys(schedules).length === 0) {
                scheduleListElement.innerHTML = `
                    <div class="schedule-item empty-schedule" style="text-align: center; padding: 40px 20px; border-left: 4px solid var(--gray-light);">
                        <i class="fas fa-calendar-alt" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 15px;"></i>
                        <h3 style="color: var(--gray); margin-bottom: 10px; font-weight: 500;">No Schedule for Today</h3>
                        <p style="color: var(--gray-light);">Add medicines using the schedule form</p>
                    </div>`;
                return;
            }

            // Get current day (0 = Sunday, 1 = Monday, etc.)
            const today = new Date().getDay();
            
            // Convert to array, filter for today, and sort by time
            const scheduleArray = Object.values(schedules)
                .filter(schedule => schedule.active && schedule.days && schedule.days.includes(today))
                .sort((a, b) => a.time.localeCompare(b.time));

            if (scheduleArray.length === 0) {
                scheduleListElement.innerHTML = `
                    <div class="schedule-item empty-schedule" style="text-align: center; padding: 40px 20px; border-left: 4px solid var(--gray-light);">
                        <i class="fas fa-calendar-alt" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 15px;"></i>
                        <h3 style="color: var(--gray); margin-bottom: 10px; font-weight: 500;">No Schedule for Today</h3>
                        <p style="color: var(--gray-light);">Add medicines for today using the form</p>
                    </div>`;
                return;
            }

            let html = '';
            scheduleArray.forEach(schedule => {
                const isDue = checkIfDue(schedule);
                html += createScheduleItemHTML(schedule, isDue);
            });
            scheduleListElement.innerHTML = html;
            
            // Add event listeners to buttons
            scheduleArray.forEach(schedule => {
                const removeBtn = scheduleListElement.querySelector(`.remove-schedule-btn[data-id="${schedule.id}"]`);
                const toggleBtn = scheduleListElement.querySelector(`.toggle-schedule-btn[data-id="${schedule.id}"]`);
                
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => removeSchedule(schedule.id));
                }
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => toggleScheduleActive(schedule.id, !schedule.active));
                }
            });
        }

        function createScheduleItemHTML(schedule, isDue) {
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const scheduleDays = schedule.days ? schedule.days.map(d => dayNames[d]).join(', ') : 'Daily';
            
            const dueClass = isDue ? 'due-now' : '';
            const statusColor = schedule.dispensed ? 'badge-success' : 'badge-warning';
            const statusText = schedule.dispensed ? 'Dispensed' : 'Pending';
            
            return `
                <div class="schedule-item ${dueClass}" data-id="${schedule.id}">
                    <div class="schedule-header">
                        <div class="medicine-name">${schedule.name}</div>
                        <div class="medicine-time">${schedule.time}</div>
                    </div>
                    <div class="medicine-details">
                        <span>Dosage: ${schedule.dosage}</span>
                        <span class="badge ${statusColor}">${statusText}</span>
                    </div>
                    <div class="medicine-details">
                        <span>Days: ${scheduleDays}</span>
                        <div>
                            <button class="btn btn-outline toggle-schedule-btn" data-id="${schedule.id}" 
                                style="width: auto; padding: 5px 15px; margin-right: 10px;">
                                <i class="fas ${schedule.active ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                                ${schedule.active ? 'Active' : 'Inactive'}
                            </button>
                            <button class="btn btn-danger remove-schedule-btn" data-id="${schedule.id}" 
                                style="width: auto; padding: 5px 15px;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        function checkIfDue(schedule) {
            if (!lastRTCTime || schedule.dispensed || !schedule.active) return false;
            
            // Extract time from RTC time (format: HH:MM:SS)
            const [hours, minutes] = lastRTCTime.split(':');
            const currentTime = `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
            
            return schedule.time === currentTime;
        }

        function removeSchedule(id) {
            if (confirm('Are you sure you want to remove this schedule?')) {
                if (db && scheduleRef) {
                    scheduleRef.child(id).remove()
                        .then(() => {
                            showToast('Schedule Removed', 'Medicine schedule deleted successfully', 'success');
                            addLog('Removed medicine schedule', 'warning');
                        })
                        .catch((error) => {
                            showToast('Error', 'Failed to remove schedule: ' + error.message, 'error');
                        });
                } else {
                    showToast('Demo Mode', 'Schedule removed (Demo Mode)', 'warning');
                    addLog('Removed medicine schedule (Demo)', 'warning');
                }
            }
        }

        function toggleScheduleActive(id, active) {
            if (db && scheduleRef) {
                scheduleRef.child(id).update({ active: active })
                    .then(() => {
                        const status = active ? 'activated' : 'deactivated';
                        showToast('Schedule Updated', `Schedule ${status} successfully`, 'success');
                        addLog(`Schedule ${status}`, 'warning');
                    })
                    .catch((error) => {
                        showToast('Error', 'Failed to update schedule: ' + error.message, 'error');
                    });
            }
        }

        function updateScheduleCounters(schedules) {
            if (!schedules) {
                document.getElementById('total-schedules').textContent = 'Total Schedules: 0';
                document.getElementById('active-count').textContent = '0 Active';
                return;
            }
            
            const total = Object.keys(schedules).length;
            const today = new Date().getDay();
            const todaySchedules = Object.values(schedules).filter(s => 
                s.days && s.days.includes(today) && s.active
            );
            
            const dispensedCount = todaySchedules.filter(s => s.dispensed).length;
            const pendingCount = todaySchedules.length - dispensedCount;
            
            document.getElementById('total-schedules').textContent = `Total Schedules: ${total}`;
            document.getElementById('active-count').textContent = `${todaySchedules.length} Active`;
            document.getElementById('dispensed-count').textContent = dispensedCount;
            document.getElementById('pending-count').textContent = pendingCount;
        }

        function startScheduleChecking() {
            if (scheduleCheckerInterval) {
                clearInterval(scheduleCheckerInterval);
            }
            
            scheduleCheckerInterval = setInterval(() => {
                if (lastRTCTime) {
                    checkScheduleAgainstTime(lastRTCTime);
                }
                updateNextCheckTimer();
            }, CHECK_INTERVAL);
            
            // Update timer every second
            setInterval(updateNextCheckTimer, 1000);
        }

        function checkScheduleAgainstTime(rtcTime) {
            if (!db || !scheduleRef) return;
            
            // Extract hour and minute from RTC time
            const timeParts = rtcTime.split(':');
            if (timeParts.length < 2) return;
            
            const currentTimeStr = timeParts[0].padStart(2, '0') + ':' + timeParts[1].padStart(2, '0');
            
            // Get current day
            const today = new Date().getDay();
            
            // Get all schedules
            scheduleRef.once('value').then((snapshot) => {
                const schedules = snapshot.val();
                if (!schedules) return;
                
                Object.values(schedules).forEach(schedule => {
                    if (schedule.active && 
                        schedule.days && 
                        schedule.days.includes(today) && 
                        !schedule.dispensed && 
                        schedule.time === currentTimeStr) {
                        
                        triggerAutoDispense(schedule, currentTimeStr);
                    }
                });
            });
            
            lastScheduleCheck = Date.now();
        }

        function triggerAutoDispense(schedule, time) {
            if (!db || !commandsRef || !autoDispenseRef) return;
            
            // Send commands to ESP32
            sendCommand('auto_dispense', true);
            sendCommand('led_on', true);
            sendCommand('buzzer_on', true);
            
            // Update schedule as dispensed
            const now = new Date().toISOString();
            scheduleRef.child(schedule.id).update({
                dispensed: true,
                lastDispensed: now
            });
            
            // Log the auto-dispense event
            addLog(`AUTO-DISPENSE: ${schedule.name} at ${time}`, 'success');
            
            // Update auto-dispense status
            autoDispenseRef.update({
                triggered: true,
                medicineName: schedule.name,
                time: time,
                timestamp: now
            });
            
            // Turn off LED and buzzer after 5 seconds
            setTimeout(() => {
                sendCommand('auto_dispense', false);
                sendCommand('led_off', true);
                sendCommand('buzzer_off', true);
            }, 5000);
            
            showToast('Auto Dispense', `Dispensing: ${schedule.name}`, 'success');
        }

        function sendCommand(command, value) {
            if (db && commandsRef) {
                commandsRef.child(command).set(value)
                    .then(() => {
                        // Reset command after a short delay (except for on/off commands)
                        if (!command.includes('_on') && !command.includes('_off')) {
                            setTimeout(() => {
                                commandsRef.child(command).set(false);
                            }, 1000);
                        }
                    })
                    .catch((error) => {
                        showToast('Command Error', 'Failed to send command: ' + error.message, 'error');
                    });
            } else {
                showToast('Demo Mode', `Command: ${command} (Demo)`, 'warning');
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            document.getElementById('current-time-display').textContent = timeString;
        }

        function updateRTCTimeDisplay(rtcTime) {
            document.getElementById('rtc-time-display').textContent = rtcTime;
            updateSyncStatus('Synchronized', 'success');
        }

        function forceTimeSync() {
            updateSyncStatus('Syncing...', 'syncing');
            
            // Send sync command to ESP32
            sendCommand('force_sync', true);
            
            // Update RTC time from system
            const now = new Date();
            const timeString = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0') + ':' + 
                now.getSeconds().toString().padStart(2, '0');
            
            if (db && rtcRef) {
                rtcRef.set(timeString)
                    .then(() => {
                        updateSyncStatus('Synchronized', 'success');
                    })
                    .catch((error) => {
                        updateSyncStatus('Sync Failed', 'error');
                    });
            } else {
                updateSyncStatus('Synced (Demo)', 'success');
            }
        }

        function updateNextCheckTimer() {
            const elapsed = Math.floor((Date.now() - lastScheduleCheck) / 1000);
            const remaining = Math.max(0, CHECK_INTERVAL/1000 - elapsed);
            document.getElementById('next-check-timer').textContent = remaining;
            
            // Update progress bar
            const progress = ((CHECK_INTERVAL/1000 - remaining) / (CHECK_INTERVAL/1000)) * 100;
            document.getElementById('schedule-progress').style.width = `${progress}%`;
        }

        function updateUptime() {
            const uptimeMs = Date.now() - systemStartTime;
            const hours = Math.floor(uptimeMs / 3600000);
            const minutes = Math.floor((uptimeMs % 3600000) / 60000);
            const seconds = Math.floor((uptimeMs % 60000) / 1000);
            
            document.getElementById('system-uptime').textContent = 
                `Uptime: ${hours}h ${minutes}m ${seconds}s`;
        }

        function addLog(message, type = 'info') {
            const logListElement = document.getElementById('log-list');
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            logItem.innerHTML = `
                <div class="log-type"></div>
                <div class="log-time">${timeString}</div>
                <div class="log-message">${message}</div>
            `;
            
            logListElement.insertBefore(logItem, logListElement.firstChild);
            
            // Keep only last 20 logs
            const logs = logListElement.querySelectorAll('.log-item');
            if (logs.length > 20) {
                logListElement.removeChild(logs[logs.length - 1]);
            }
            
            // Update log count
            document.getElementById('log-count').textContent = logs.length;
            
            // Also save to Firebase if connected
            if (db && logsRef && type !== 'demo') {
                const logData = {
                    message: message,
                    type: type,
                    timestamp: now.toISOString()
                };
                logsRef.push(logData);
            }
        }

        function updateLogDisplay(logs) {
            // This function handles live updates from Firebase
        }

        function clearLogs() {
            const logListElement = document.getElementById('log-list');
            logListElement.innerHTML = `
                <div class="log-item log-info">
                    <div class="log-type"></div>
                    <div class="log-time">[System]</div>
                    <div class="log-message">Logs cleared</div>
                </div>`;
            
            if (db && logsRef) {
                logsRef.remove()
                    .then(() => {
                        addLog('Logs cleared', 'warning');
                        showToast('Logs Cleared', 'All logs have been cleared', 'warning');
                    })
                    .catch((error) => {
                        showToast('Error', 'Failed to clear logs: ' + error.message, 'error');
                    });
            } else {
                addLog('Logs cleared (Demo Mode)', 'warning');
                showToast('Demo Mode', 'Logs cleared (Demo)', 'warning');
            }
            
            document.getElementById('log-count').textContent = '1';
        }

        function updateConnectionStatus(message, type) {
            if (!connectionStatusElement) return;
            
            connectionStatusElement.textContent = message;
            const statusDot = document.getElementById('status-dot');
            
            if (type === 'success') {
                statusDot.style.backgroundColor = 'var(--secondary)';
                statusDot.style.boxShadow = '0 0 20px var(--secondary)';
            } else if (type === 'error') {
                statusDot.style.backgroundColor = 'var(--danger)';
                statusDot.style.boxShadow = '0 0 20px var(--danger)';
            } else if (type === 'warning') {
                statusDot.style.backgroundColor = 'var(--warning)';
                statusDot.style.boxShadow = '0 0 20px var(--warning)';
            }
        }

        function updateFirebaseStatus(message) {
            if (firebaseStatusElement) {
                firebaseStatusElement.textContent = message;
            }
        }

        function updateSyncStatus(message, type) {
            const syncDot = document.getElementById('sync-dot');
            const syncStatusText = document.getElementById('sync-status-text');
            
            if (syncDot && syncStatusText) {
                syncStatusText.textContent = `Time Sync: ${message}`;
                syncDot.className = 'sync-dot';
                
                if (type === 'success') {
                    syncDot.classList.add('success');
                    syncDot.style.backgroundColor = 'var(--secondary)';
                } else if (type === 'error') {
                    syncDot.classList.add('error');
                    syncDot.style.backgroundColor = 'var(--danger)';
                } else if (type === 'syncing') {
                    syncDot.classList.add('syncing');
                    syncDot.style.backgroundColor = 'var(--warning)';
                }
            }
        }

        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastIcon = toast.querySelector('.toast-icon i');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast toast-${type}`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set icon based on type
            switch(type) {
                case 'success':
                    toastIcon.className = 'fas fa-check-circle';
                    break;
                case 'error':
                    toastIcon.className = 'fas fa-exclamation-circle';
                    break;
                case 'warning':
                    toastIcon.className = 'fas fa-exclamation-triangle';
                    break;
                default:
                    toastIcon.className = 'fas fa-info-circle';
            }
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Demo data for testing without Firebase
        function initializeDemoData() {
            addLog('Running in Demo Mode - No Firebase connection', 'warning');
            
            // Simulate RTC time updates every second
            setInterval(() => {
                const now = new Date();
                const rtcTime = 
                    now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0') + ':' + 
                    now.getSeconds().toString().padStart(2, '0');
                updateRTCTimeDisplay(rtcTime);
                
                // Simulate schedule checking
                if (Math.random() > 0.9) {
                    const demoMedicines = ['Vitamin C 500mg', 'Metformin 850mg', 'Aspirin 81mg'];
                    const randomMedicine = demoMedicines[Math.floor(Math.random() * demoMedicines.length)];
                    addLog(`DEMO: Auto-dispensing ${randomMedicine}`, 'success');
                }
            }, 1000);
            
            updateConnectionStatus('Demo Mode - Simulated System', 'warning');
            updateFirebaseStatus('Demo Mode');
        }
    </script>
</body>
</html>
